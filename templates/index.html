<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ß–∞—Ç –∑ –ë–æ—Ç–æ–º</title>
<link rel="stylesheet" href="static/chat.css">
<style>
:root {
    --bg-body: #1c1c1c;
    --text-body: #e6eef6;
    --bg-container: #2b2b2b;
    --bg-user: #3a3a3a;
    --bg-bot: #444;
    --text-bot: #e6eef6;
    --glow-color: #00ffff;
}

body {
    margin: 0;
    font-family: "Inter", sans-serif;
    background: var(--bg-body);
    color: var(--text-body);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    transition: background 0.3s, color 0.3s;
}

.container {
    width: 90%;
    max-width: 800px;
    display: flex;
    flex-direction: column;
    height: 90vh;
    background: var(--bg-container);
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 0 25px rgba(0,0,0,.5);
    transition: background 0.3s;
}

header {
    text-align: center;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 5px;
}

header h1 { margin: 0; }

main {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
}

.msg {
    padding: 10px 12px;
    margin: 8px 0;
    border-radius: 8px;
    max-width: 80%;
    white-space: pre-wrap;
    word-break: break-word;
    opacity: 0;
    transform: translateY(10px);
    animation: slideIn 0.3s forwards;
}

.msg.user {
    background: var(--bg-user);
    color: #fff;
    margin-left: auto;
    box-shadow: 0 0 8px rgba(0,255,255,0.3);
}

.msg.bot {
    background: var(--bg-bot);
    color: var(--text-bot);
    margin-right: auto;
    box-shadow: 0 0 8px rgba(0,255,255,0.2);
}

.msg.bot a {
    color: #4fc3f7;
    text-decoration: underline;
}

.msg.typing span {
    display: inline-block;
    width: 6px;
    height: 6px;
    margin: 0 2px;
    background: var(--text-bot);
    border-radius: 50%;
    animation: blink 1s infinite;
}

.msg.typing span:nth-child(2) { animation-delay: 0.2s; }
.msg.typing span:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }
@keyframes slideIn { to { opacity: 1; transform: translateY(0); } }

form { display: flex; gap: 6px; margin-top: 8px; }
input { flex: 1; padding: 10px; border-radius: 6px; border: none; outline: none; }
button { padding: 10px 12px; border-radius: 6px; border: none; cursor: pointer; }

#stopBtn { background: #c0392b; color: #fff; }
#sendBtn { background: #555; color: #fff; }
#clearBtn { background: #8e44ad; color: #fff; }
#speedRange { width: 120px; }

.footer { text-align: center; margin-top: 8px; font-size: 0.85em; color: #aaa; }
</style>
</head>
<body>
<div class="container" id="container">
    <header>
        <h1>–ß–∞—Ç</h1>
        <div>
            <label>–¢–µ–º–∞:
                <select id="themeSelect">
                    <option value="dark">–¢–µ–º–Ω–∞</option>
                    <option value="light">–°–≤—ñ—Ç–ª–∞</option>
                </select>
            </label>
            <button id="fullscreenBtn">‚õ∂</button>
            <button id="clearBtn">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç</button>
        </div>
    </header>

    <main id="chat"></main>

    <form onsubmit="sendMessage(event)">
        <input type="text" id="message" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." autocomplete="off">
        <button type="submit" id="sendBtn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        <button type="button" id="stopBtn" disabled>STOP</button>
        <label>–®–≤–∏–¥–∫—ñ—Å—Ç—å:
            <input type="range" id="speedRange" min="10" max="150" value="80">
        </label>
    </form>

    <div class="footer">–ó—Ä–æ–±–ª–µ–Ω–æ –Ω–∞ –±–∞–∑—ñ Groq</div>
</div>

<script>
let typingIndicator;
let isBotTyping = false;
let stopPressed = false;
let fullResponseCache = "";

const stopBtn = document.getElementById("stopBtn");
const inputField = document.getElementById("message");
const sendBtn = document.getElementById("sendBtn");
const speedRange = document.getElementById("speedRange");
const themeSelect = document.getElementById("themeSelect");
const fullscreenBtn = document.getElementById("fullscreenBtn");
const clearBtn = document.getElementById("clearBtn");
const chat = document.getElementById("chat");

// === –í–Ü–î–ù–û–í–õ–ï–ù–ù–Ø –Ü–°–¢–û–†–Ü–á ===
window.addEventListener("load", () => {
    const savedChat = JSON.parse(localStorage.getItem("chatHistory") || "[]");
    savedChat.forEach(m => addMessage(m.text, m.type, false));
    chat.scrollTop = chat.scrollHeight;
});

// === –ü–û–í–ù–û–ï–ö–†–ê–ù–ù–ò–ô –†–ï–ñ–ò–ú ===
fullscreenBtn.addEventListener("click", () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
});

// === –¢–ï–ú–ê ===
themeSelect.addEventListener("change", () => setTheme(themeSelect.value));

// === –°–¢–û–ü ===
stopBtn.addEventListener("click", () => {
    if (!isBotTyping) return;
    stopPressed = true;
});

// === –û–ß–ò–°–¢–ö–ê –ß–ê–¢–£ ===
clearBtn.addEventListener("click", () => {
    if (confirm("–û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —á–∞—Ç—É?")) {
        chat.innerHTML = "";
        localStorage.removeItem("chatHistory");
    }
});

// === –ù–ê–î–°–ò–õ–ê–ù–ù–Ø ===
async function sendMessage(event) {
    event.preventDefault();
    if (isBotTyping) return;

    const text = inputField.value.trim();
    if (!text) return;

    addMessage(text, "user");
    inputField.value = "";
    inputField.disabled = true;
    sendBtn.disabled = true;
    stopBtn.disabled = false;

    showTypingIndicator();
    isBotTyping = true;
    stopPressed = false;

    try {
        await new Promise(r => setTimeout(r, 700));
        const responseText = await getBotResponse(text);
        hideTypingIndicator();

        const speed = parseInt(speedRange.value);
        await typeBotMessage(responseText, speed);
    } catch {
        hideTypingIndicator();
        addMessage("‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º", "bot");
    }

    isBotTyping = false;
    stopBtn.disabled = true;
    inputField.disabled = false;
    sendBtn.disabled = false;
    inputField.focus();
    saveChatHistory();
}

// === –î–û–î–ê–Ñ –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø ===
function addMessage(text, type, save = true) {
    const msg = document.createElement("div");
    msg.className = "msg " + type;
    msg.innerHTML = linkify(text);
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
    if (save) saveChatHistory();
    return msg;
}

// === –Ü–ù–î–ò–ö–ê–¢–û–† –ù–ê–ë–û–†–£ ===
function showTypingIndicator() {
    typingIndicator = document.createElement("div");
    typingIndicator.className = "msg bot typing";
    typingIndicator.innerHTML = "<span></span><span></span><span></span>";
    chat.appendChild(typingIndicator);
    chat.scrollTop = chat.scrollHeight;
}
function hideTypingIndicator() { if (typingIndicator) typingIndicator.remove(); }

// === –ù–ê–ë–Ü–† –¢–ï–ö–°–¢–£ ===
async function typeBotMessage(text, speed) {
    const msg = addMessage("", "bot");
    for (let i = 0; i < text.length; i++) {
        if (stopPressed) {
            msg.innerHTML = linkify(text);
            break;
        }
        msg.textContent += text[i];
        chat.scrollTop = chat.scrollHeight;
        await new Promise(r => setTimeout(r, 160 - speed));
    }
    saveChatHistory();
}

// === –ö–õ–Ü–ö–ê–ë–ï–õ–¨–ù–Ü –ü–û–°–ò–õ–ê–ù–ù–Ø ===
function linkify(text) {
    const urlPattern = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlPattern, '<a href="$1" target="_blank">$1</a>');
}

// === –¢–ï–ú–ò ===
function setTheme(theme) {
    if (theme === 'dark') {
        document.documentElement.style.setProperty('--bg-body', '#1c1c1c');
        document.documentElement.style.setProperty('--text-body', '#e6eef6');
        document.documentElement.style.setProperty('--bg-container', '#2b2b2b');
        document.documentElement.style.setProperty('--bg-user', '#3a3a3a');
        document.documentElement.style.setProperty('--bg-bot', '#444');
        document.documentElement.style.setProperty('--text-bot', '#e6eef6');
    } else {
        document.documentElement.style.setProperty('--bg-body', '#f5f5f5');
        document.documentElement.style.setProperty('--text-body', '#222');
        document.documentElement.style.setProperty('--bg-container', '#fff');
        document.documentElement.style.setProperty('--bg-user', '#ddd');
        document.documentElement.style.setProperty('--bg-bot', '#eee');
        document.documentElement.style.setProperty('--text-bot', '#222');
    }
}

// === –í–Ü–î–ü–û–í–Ü–î–¨ –ë–û–¢–ê ===
async function getBotResponse(text) {
    try {
        const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: text })
        });
        const data = await res.json();
        return data.response || "‚ö†Ô∏è –ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ";
    } catch {
        return "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è.";
    }
}

// === –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –Ü–°–¢–û–†–Ü–á ===
function saveChatHistory() {
    const msgs = Array.from(chat.children).map(div => ({
        text: div.textContent,
        type: div.classList.contains("user") ? "user" : "bot"
    }));
    localStorage.setItem("chatHistory", JSON.stringify(msgs));
}
</script>
</body>
</html>
